---
phase: 02-knockout-bracket
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [KNP-01, KNP-02, KNP-03, KNP-04, KNP-05, KNP-06, KNP-07, KNP-08, KNP-09]

must_haves:
  truths:
    - "User can access /knockouts page from dashboard"
    - "Visual bracket displays all knockout matches"
    - "User can tap/click to select winners for each match"
    - "Bracket updates visually as selections are made"
    - "Predictions persist to database"
    - "Mobile view is usable (vertical scroll or simplified)"
    - "User can edit predictions before deadline"
  artifacts:
    - path: "world-cup-predictor/src/app/knockouts/page.tsx"
      provides: "Knockout bracket page with prediction interface"
      exports: "KnockoutsPage component"
    - path: "world-cup-predictor/src/app/api/predictions/route.ts"
      provides: "GET/POST predictions supporting KNOCKOUT type"
      contains: "knockoutRound field handling"
  key_links:
    - from: "src/app/knockouts/page.tsx"
      to: "/api/predictions"
      via: "POST request"
      pattern: "fetch.*method.*POST.*KNOCKOUT"
    - from: "src/app/knockouts/page.tsx"
      to: "/api/predictions"
      via: "GET request"
      pattern: "fetch.*predictions.*KNOCKOUT"
---

<objective>
Create the Knockout Bracket page with visual bracket display and prediction interface for all knockout rounds (Round of 32 through Final, including Third Place).

Purpose: Users can predict winners for each knockout match and see their bracket progression visually
Output: /knockouts page with interactive bracket UI
</objective>

<execution_context>
@C:/Users/lenovo/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/lenovo/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-knockout-bracket/02-CONTEXT.md
@world-cup-predictor/src/app/groups/page.tsx
@world-cup-predictor/src/app/summary/page.tsx
@world-cup-predictor/src/app/api/predictions/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Knockout Bracket Page with Visual Display</name>
  <files>world-cup-predictor/src/app/knockouts/page.tsx</files>
  <action>
Create the /knockouts page component:

1. **Bracket Structure**: Build a visual knockout bracket with:
   - Round of 32 (16 matches)
   - Round of 16 (8 matches)
   - Quarter-finals (4 matches)
   - Semi-finals (2 matches)
   - Third place match
   - Final match

2. **Match Data**: Use hardcoded match structure (teams determined by group winners/third-place):
   - Define match IDs for each round (e.g., "r32-1", "r16-1", "qf-1", "sf-1", "third", "final")
   - Each match has: matchId, round, team1, team2

3. **Visual Design**:
   - Use bracket-style layout with connecting lines between rounds
   - Each match shows two team slots (clickable)
   - Selected winner highlighted with brand colors (blue/yellow)
   - Follow existing UI patterns: glassmorphism cards, gradient backgrounds

4. **Third Place Handling**: Display third place match between semi-final losers

5. **Mobile Responsive**:
   - Horizontal scroll for desktop
   - Vertical stacked rounds for mobile (or horizontal scroll)
   - Touch-friendly tap targets (min 44px)

Reference existing pages for styling: dashboard/page.tsx, groups/page.tsx
  </action>
  <verify>1. Navigate to /knockouts
2. Verify all rounds displayed (R32, R16, QF, SF, Third, Final)
3. Check bracket lines connect rounds visually
4. Test mobile view with responsive design
5. Verify empty state shows "Select winner" for each match</verify>
  <done>Knockout bracket page renders with all rounds visible, follows existing design patterns, is mobile responsive</done>
</task>

<task type="auto">
  <name>Task 2: Add Winner Selection and Prediction Saving</name>
  <files>world-cup-predictor/src/app/knockouts/page.tsx</files>
  <action>
Implement interactivity for winner selection:

1. **State Management**:
   - Track selected winners: `{ [matchId]: teamId }`
   - Load existing predictions on mount via GET /api/predictions

2. **Selection Logic**:
   - Click on team to select as winner
   - Selected team gets visual highlight (border, background)
   - Selection automatically advances winner to next round in bracket

3. **Auto-Advance**:
   - When winner selected in R32, auto-populate that team in corresponding R16 match
   - Chain forward: R32 → R16 → QF → SF → Final
   - Allow overriding auto-advanced selections

4. **Save Functionality**:
   - "Done" button saves all predictions via POST /api/predictions
   - Payload: `{ predictions: [{ type: "KNOCKOUT", knockoutRound: "r32", teamOrder: [winnerId] }, ...] }`
   - Use knockoutRound as matchId for storage
   - Redirect to /summary after save

5. **Edit Mode**:
   - Load existing predictions on page load
   - Allow re-selecting winners before tournament starts
   - Show "Edit Predictions" link from /summary page
  </action>
  <verify>1. Click on a team in R32 match - should highlight as winner
2. Verify winner auto-advances to R16 position
3. Make selections across all rounds
4. Click "Done" - should save and redirect
5. Return to page - previous selections should persist
6. Edit existing prediction - should update correctly</verify>
  <done>Users can select winners for all matches, selections auto-advance through bracket, predictions persist to database</done>
</task>

</tasks>

<verification>
- /knockouts page renders full bracket with all rounds
- Users can tap/click to select winners for each match
- Bracket updates visually as selections made
- Mobile view is usable
- Predictions persist to database
- "Done" button saves and redirects to summary
- Edit functionality works for existing predictions
</verification>

<success_criteria>
1. /knockouts page renders full 64-match bracket (KNP-01 to KNP-06)
2. Users can tap/click to select winners for each match (KNP-01 to KNP-06)
3. Bracket updates visually as selections made (KNP-07)
4. Mobile view is usable - vertical scroll or simplified (KNP-09)
5. Predictions persist to database (KNP-08)
6. "Done" button saves and redirects to dashboard (KNP-08)
7. User can edit predictions before deadline (KNP-08)
</success_criteria>

<output>
After completion, create `.planning/phases/02-knockout-bracket/02-SUMMARY.md`
</output>
