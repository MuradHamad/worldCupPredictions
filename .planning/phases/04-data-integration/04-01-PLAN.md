---
phase: 04-data-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [DATA-01, DATA-02, DATA-03, DATA-04]

must_haves:
  truths:
    - "Teams stored in database (not hardcoded)"
    - "Match data fetched from external API with validation"
    - "API responses validated with Zod"
    - "Rate limiting handled for external API"
  artifacts:
    - path: "world-cup-predictor/prisma/seed.ts"
      provides: "Database seed script for teams"
      exports: "48 team records with names, codes, groups"
    - path: "world-cup-predictor/src/lib/api/matches.ts"
      provides: "External API service for fetching match data"
      exports: "fetchMatchResults function with caching"
    - path: "world-cup-predictor/src/lib/api/schemas.ts"
      provides: "Zod schemas for API response validation"
      exports: "MatchResultSchema, TeamSchema"
    - path: "world-cup-predictor/src/lib/api/cache.ts"
      provides: "Simple in-memory cache with TTL"
      exports: "Cache class with get/set/delete"
    - path: "world-cup-predictor/src/app/api/external/matches/route.ts"
      provides: "API proxy for external match data"
      exports: "GET endpoint with caching"
---

<objective>
Implement Data Integration to migrate teams to database, prepare external API integration with Zod validation, and handle rate limiting. This includes seeding the database with all 48 teams, creating an API service to fetch match data, adding Zod schemas for validation, and implementing caching to prevent rate limit exhaustion.

Purpose: Prepare the system to fetch real match data from external APIs while maintaining data integrity and preventing rate limit issues.
Output: Team data in database, API service with validation and caching
</objective>

<execution_context>
@C:/Users/lenovo/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/lenovo/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@world-cup-predictor/prisma/schema.prisma
@world-cup-predictor/src/app/api/matches/route.ts
@world-cup-predictor/AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install required dependencies</name>
  <files>world-cup-predictor/package.json</files>
  <action>
Install necessary packages for Phase 4:

1. Install Zod for API validation:
   npm install zod

2. Install Axios for HTTP requests:
   npm install axios

These packages enable API validation (Zod) and external API communication (Axios).
  </action>
  <verify>1. Check package.json includes zod and axios
2. Verify packages are in node_modules
3. Run npm list zod axios</verify>
  <done>Zod and Axios installed in project</done>
</task>

<task type="auto">
  <name>Task 2: Create team seed data</name>
  <files>world-cup-predictor/prisma/seed.ts</files>
  <action>
Create seed script with all 48 teams for the Global Cup:

1. Create prisma/seed.ts with 48 teams
2. Each team has: name, code (3-letter), group (A-L), flag (emoji or URL)
3. Include teams from all 12 groups (4 teams per group)

Group A: Argentina, Canada, Mexico, Saudi Arabia
Group B: Albania, Croatia, Spain, Italy
Group C: Australia, Denmark, England, Serbia
Group D: Algeria, Brazil, Morocco, Croatia
Group E: Belgium, Romania, Slovakia, Ukraine
Group F: Brazil, Croatia, Morocco, Canada
Group G: Colombia, Germany, Japan, Spain
Group H: Argentina, Bolivia, Canada, Peru
Group I: Belgium, France, Portugal, Spain
Group J: Denmark, England, Finland, Norway
Group K: Cameroon, Netherlands, Senegal, Serbia
Group L: Brazil, Colombia, Paraguay, Venezuela

Note: Use placeholder "Global Cup" teams since actual 2026 qualification not complete.
Use generic but realistic team names.
  </action>
  <verify>1. Check seed.ts file exists
2. Verify 48 teams defined
3. All 12 groups represented</verify>
  <done>Seed script contains all 48 teams</done>
</task>

<task type="auto">
  <name>Task 3: Run database seed</name>
  <files>world-cup-predictor/prisma/seed.ts</files>
  <action>
Execute the seed script to populate teams table:

1. Add seed script to package.json if not present:
   "prisma": {
     "seed": "npx ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
   }

2. Run: npx prisma db seed

3. Verify teams were inserted:
   - Query team count should be 48
   - Check teams exist for each group
  </action>
  <verify>1. Run seed command
2. Check database has 48 teams
3. Verify teams grouped correctly (4 per group)</verify>
  <done>48 teams populated in database</done>
</task>

<task type="auto">
  <name>Task 4: Create cache utility</name>
  <files>world-cup-predictor/src/lib/api/cache.ts</files>
  <action>
Create a simple in-memory cache to prevent API rate limiting:

1. Create src/lib/api/cache.ts
2. Implement Cache class with:
   - get<T>(key: string): T | null
   - set<T>(key: string, value: T, ttlSeconds: number): void
   - delete(key: string): void
   - Internal Map for storage
   - Cleanup expired entries on get/set

3. Default TTL: 5 minutes for match data
4. Store in memory (not persistent)
  </action>
  <verify>1. Check cache.ts file exists
2. Test cache get/set/delete
3. Verify TTL expiration works</verify>
  <done>Cache utility handles in-memory storage with TTL</done>
</task>

<task type="auto">
  <name>Task 5: Create Zod validation schemas</name>
  <files>world-cup-predictor/src/lib/api/schemas.ts</files>
  <action>
Create Zod schemas for API response validation:

1. Create src/lib/api/schemas.ts
2. Define schemas:
   - TeamSchema: { id, name, code, group, flag }
   - MatchResultSchema: { id, homeTeam, awayTeam, homeScore, awayScore, status, startTime }
   - MatchStatusSchema: enum for 'SCHEDULED', 'LIVE', 'FINISHED', 'POSTPONED'

3. Use strict() mode to prevent extra fields
4. Add validation helpers: validateMatchResult(), validateTeam()
  </action>
  <verify>1. Check schemas.ts file exists
2. Validate sample data with schemas
3. Verify schema validation rejects invalid data</verify>
  <done>Zod schemas validate API responses</done>
</task>

<task type="auto">
  <name>Task 6: Create external API service</name>
  <files>world-cup-predictor/src/lib/api/matches.ts</files>
  <action>
Create API service for fetching match data:

1. Create src/lib/api/matches.ts
2. Implement fetchMatchResults() function:
   - Accept date range (optional)
   - Use axios for HTTP requests
   - Apply caching (5 min TTL)
   - Handle API errors gracefully
   - Return validated data

3. For MVP, use mock data endpoint that can be swapped for real API
4. Include:
   - fetchLiveMatches()
   - fetchUpcomingMatches()
   - fetchMatchById(matchId)

5. Rate limit handling:
   - Cache responses
   - Track API calls
   - Implement exponential backoff on failure
  </action>
  <verify>1. Check matches.ts file exists
2. Call fetchMatchResults()
3. Verify data is cached on subsequent calls
4. Check rate limiting works</verify>
  <done>API service fetches match data with caching</done>
</task>

<task type="auto">
  <name>Task 7: Create external API endpoint</name>
  <files>world-cup-predictor/src/app/api/external/matches/route.ts</files>
  <action>
Create API endpoint to proxy external match data:

1. Create src/app/api/external/matches/route.ts
2. Implement GET endpoint:
   - Query params: ?date=YYYY-MM-DD (optional)
   - Returns cached or fresh match data
   - Validates responses with Zod

3. Add rate limit headers:
   - X-RateLimit-Limit
   - X-RateLimit-Remaining
   - X-RateLimit-Reset

4. Error handling:
   - Return 500 on API failure
   - Include error message in response
  </action>
  <verify>1. Test GET /api/external/matches
2. Check response has valid data
3. Verify rate limit headers present
4. Test error handling</verify>
  <done>API endpoint serves match data with rate limit info</done>
</task>

<task type="auto">
  <name>Task 8: Update /api/matches to use external API</name>
  <files>world-cup-predictor/src/app/api/matches/route.ts</files>
  <action>
Update the existing matches API to optionally fetch from external source:

1. Read existing /api/matches/route.ts
2. Add optional parameter: ?source=local|external
3. If source=external, call fetchMatchResults()
4. Merge external results with local MatchResult table
5. Allow admin to sync external results to local DB
  </action>
  <verify>1. Test local match results still work
2. Test external source parameter
3. Verify data merging works</verify>
  <done>Matches API supports both local and external sources</done>
</task>

<task type="checkpoint:human-verify">
  <name>Checkpoint: Verify Data Integration</name>
  <action>
Manually verify the complete data integration flow:

1. **Teams in Database**: 
   - Query /api/teams or check database
   - Should see 48 teams with groups A-L

2. **API Validation**:
   - Send invalid data to /api/external/matches
   - Should receive validation error

3. **Caching**:
   - Call /api/external/matches twice
   - Second call should be faster (cached)

4. **Rate Limiting**:
   - Check response headers for rate limit info
   - Verify X-RateLimit-Remaining decrements

5. **Error Handling**:
   - Test with invalid API endpoint
   - Should return graceful error

Report the results observed.
  </action>
</task>

</tasks>

<verification>
- 48 teams seeded in database (DATA-01)
- External API service exists (DATA-02)
- Zod schemas validate responses (DATA-03)
- Cache prevents rate limit exhaustion (DATA-04)
</verification>

<success_criteria>
1. Teams stored in database with all 48 teams (DATA-01)
2. External API service fetches match data (DATA-02)
3. Zod schemas validate all API responses (DATA-03)
4. Rate limiting handled via caching (DATA-04)
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-integration/04-SUMMARY.md`
</output>
